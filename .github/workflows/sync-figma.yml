name: Sync Figma Files from Testweb

on:
  # Manuell auslösbar in GitHub Actions UI
  workflow_dispatch:

  # Alle 15 Minuten prüfen ob Testweb neue Commits hat
  schedule:
    - cron: '*/15 * * * *'

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout getmaca_website (Produktion)
        uses: actions/checkout@v4
        with:
          path: production
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout Testweb (Figma Source, public)
        uses: actions/checkout@v4
        with:
          repository: wax7/Testweb
          path: figma

      - name: Check for Figma changes
        id: check
        run: |
          # Letzten synced Commit merken (falls Datei existiert)
          LAST_SYNC=""
          if [ -f production/.figma-last-sync ]; then
            LAST_SYNC=$(cat production/.figma-last-sync)
          fi

          # Aktuellen Figma Commit holen
          CURRENT=$(cd figma && git rev-parse HEAD)
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"

          if [ "$LAST_SYNC" = "$CURRENT" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "Keine neuen Figma-Aenderungen (letzter Sync: $CURRENT)"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Neue Figma-Aenderungen gefunden! Sync von $LAST_SYNC zu $CURRENT"
          fi

      - name: Sync Figma files
        if: steps.check.outputs.changed == 'true'
        run: |
          set -e
          cd production

          echo "Synce Figma-Dateien..."

          # 1) src/ komplett uebernehmen
          if [ -d ../figma/src ]; then
            rm -rf src/
            cp -r ../figma/src/ src/
            echo "src/ synced"
          fi

          # ── 2) index.html übernehmen ──
          if [ -f ../figma/index.html ]; then
            cp ../figma/index.html index.html
          fi

          # ── 3) public/ Ordner NICHT anfassen ──
          # public/ enthaelt Produktions-Dateien wie sitemap.xml, robots.txt
          # Diese werden von Figma Sync nicht beruehrt!

          # ── 4) package.json: Figma-Dependencies übernehmen, ──
          #        aber unsere Scripts + devDependencies behalten
          if [ -f ../figma/package.json ]; then
            # Installiere jq für JSON-Merge
            sudo apt-get -qq install -y jq > /dev/null 2>&1

            # Figma-Dependencies extrahieren
            FIGMA_DEPS=$(jq '.dependencies // {}' ../figma/package.json)

            # In unser package.json mergen (überschreibt nur dependencies)
            jq --argjson deps "$FIGMA_DEPS" '.dependencies = $deps' package.json > package.json.tmp
            mv package.json.tmp package.json
          fi

          # ── 5) vite.config.ts übernehmen, aber outDir: 'build' sichern ──
          if [ -f ../figma/vite.config.ts ]; then
            cp ../figma/vite.config.ts vite.config.ts

            # Sicherstellen dass outDir: 'build' gesetzt ist
            if grep -q "outDir:" vite.config.ts; then
              # outDir bereits vorhanden → auf 'build' setzen
              sed -i "s/outDir:.*$/outDir: 'build',/" vite.config.ts
            else
              # outDir fehlt → nach 'build: {' einfügen
              sed -i "/build: {/a\\      target: 'esnext',\n      outDir: 'build'," vite.config.ts
            fi
          fi

          # ── 6) Letzten Sync-Commit merken ──
          echo "${{ steps.check.outputs.current }}" > .figma-last-sync

          echo "Sync abgeschlossen!"

      - name: Commit & Push
        if: steps.check.outputs.changed == 'true'
        run: |
          cd production
          git config user.name "Figma Sync Bot"
          git config user.email "figma-sync@getmaca.de"

          git add -A

          # Nur committen wenn es tatsächlich Änderungen gibt
          if git diff --staged --quiet; then
            echo "Keine Datei-Aenderungen nach Sync."
          else
            FIGMA_SHORT=$(echo "${{ steps.check.outputs.current }}" | cut -c1-7)
            git commit -m "feat: sync Figma design update (${FIGMA_SHORT})"
            git pull --rebase origin main
            git push
            echo "Figma-Update gepusht!"
          fi
